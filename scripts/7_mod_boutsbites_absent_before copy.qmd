---
title: "Model bouts & bites Before <> After"
format: html
editor: visual
---

### Libraries

```{r}
library(here) # easier paths, here() function starts in the folder of the RStudio project
library(tidyverse)
library(brms)
library(tidybayes)
library(ggtern)
library(kableExtra)

# get custom functions
source(here("scripts/functions.R"))
```

### Get data

```{r}
dat_bites_ab_be <- readRDS(here("data/clean/dat_absent_before.rds")) %>% 
  filter(bite>0) 

dat_bites_ab_be <- dat_bites_ab_be %>% 
  mutate(log_n_frame_total = log(n_frame_total),
         log_depth = log(depth))
```

### Overviews

Overview table

```{r}
dat_bites_ab_be %>%
  group_by(size_class, year, treatment) %>%
  summarise(n_total = n(),
            mean_bites = mean(bite, na.rm = T) %>%
              round(2),
            mean_bouts = mean(bout, na.rm = T) %>%
              round(2)) %>%
  #select relevant columns
  select(treatment, n_total, mean_bites, mean_bouts) %>%
  ungroup() %>%
  # group HTML table by size classes
  #select(-size_class) %>%
  nice_table() #%>%
  # pack_rows("<50", 1, 4) %>%
  # pack_rows("50-100", 5, 8) %>%
  # pack_rows(">100", 9, 12)
```

Not enough combinations of groups

Bites

```{r}
dat_bites_ab_be %>%
  group_by(size_class, treatment, year) %>%
  summarise(
    mean_bites = mean(bite, na.rm = T),
    sd = sd(bite, na.rm = T),
    n = n(),
    se = ifelse(n >= 3, sd / sqrt(n), NA)
  ) %>%
  ggplot() +
  geom_errorbar(aes(
    x = treatment,
    ymin = mean_bites - se,
    ymax = mean_bites + se,
    col = factor(treatment),
    width = .4
  )) +
  geom_point(aes(
    x = treatment,
    y = mean_bites,
    col = factor(treatment)
  )) +
  facet_grid(year ~ size_class , scales = "free") +
  theme_clean()
```

Bouts

```{r}
dat_bites_ab_be %>%
  group_by(size_class, treatment, year) %>%
  summarise(
    mean_bites = mean(bout, na.rm = T),
    sd = sd(bout, na.rm = T),
    n = n(),
    se = ifelse(n >= 3, sd / sqrt(n), NA)
  ) %>%
  ggplot() +
  geom_errorbar(aes(
    x = treatment,
    ymin = mean_bites - se,
    ymax = mean_bites + se,
    col = factor(treatment),
    width = .4
  )) +
  geom_point(aes(
    x = treatment,
    y = mean_bites,
    col = factor(treatment)
  )) +
  facet_grid(year ~ size_class , scales = "free") +
  theme_clean()
```

Only model small fish

```{r}
dat_bites_ab_be_S <- dat_bites_ab_be %>% 
  filter(size_class == "<50") %>% 
  droplevels()
```

### Models Bites

#### **Small**

Smooth not possible, remove all covariates, not enough combinations

```{r}
fit_bites_ab_be_S <- brm(
  bite ~ factor(year) * treatment + (1|video),
  data = dat_bites_ab_be_S,
  family = poisson,  
  control = list(max_treedepth = 12, adapt_delta = 0.98),
  iter = 4000,
  warmup = 2000,
  chains = 4,
  cores = 4,
  seed = 123,
  file_refit = "on_change",
  file = here("models/fit_bites_ab_be_S"),
  threads = threading(2, static = T),
  backend = "cmdstanr"
)
  
summary(fit_bites_ab_be_S)#ok, 1 divergent transition
pp_check(fit_bites_ab_be_S, ndraws = 100)
bayes_R2(fit_bites_ab_be_S)#0.55
```

#### Predict

```{r}
pred_bites_ab_be_S <-  predicted_draws(
  fit_bites_ab_be_S,
  newdata = expand_grid(
    year = dat_bites_ab_be_S$year %>% unique(),
    treatment = dat_bites_ab_be_S$treatment %>% unique()),
  re_formula = NA
)
```

```{r}
cols_treat <- c("#FFDB6D", "#4E84C4")

pred_bites_ab_be_S %>%
  ggplot(aes(x = .prediction, y = year)) +
  stat_slab(size = .3,
            aes(fill = treatment),
            slab_size = 0.5, 
            alpha = 0.3) +
  stat_slab(show.legend = F, 
            size = .3,
            fill = NA, 
            aes(colour = treatment), 
            slab_size = 0.5) +
  scale_colour_manual(values = cols_treat)+
  scale_fill_manual(values = cols_treat)+
  guides(color = guide_legend(override.aes = list(alpha = 1)),
         fill = guide_legend(override.aes = list(alpha = 1)))+
  theme_clean()
```

Expected values

```{r}
epred_bites_ab_be_S <-  epred_draws(
  fit_bites_ab_be_S,
  newdata = expand_grid(
    year = dat_bites_ab_be_S$year %>% unique(),
    treatment = dat_bites_ab_be_S$treatment %>% unique()),
  re_formula = NA
)
```

```{r}
epred_bites_ab_be_S %>%
  ggplot(aes(x = .epred, y = year)) +
  stat_slab(size = .3,
            aes(fill = treatment),
            slab_size = 0.5, 
            alpha = 0.3) +
  stat_slab(show.legend = F, 
            size = .3,
            fill = NA, 
            aes(colour = treatment), 
            slab_size = 0.5) +
  scale_colour_manual(values = cols_treat)+
  scale_fill_manual(values = cols_treat)+
  guides(color = guide_legend(override.aes = list(alpha = 1)),
         fill = guide_legend(override.aes = list(alpha = 1)))+
  theme_clean()
```

```{r}
epred_bites_ab_be_S_effect <- epred_bites_ab_be_S %>%
  ungroup() %>%
  dplyr::select(year,
                treatment,
                .draw,
                .epred) %>%
  pivot_wider(names_from = treatment, values_from = .epred) %>%
  mutate(diff = absent - before)
```

```{r}
cols_year <- c("#52854C", "#D16103")

epred_bites_ab_be_S_effect %>% 
  ggplot(aes(x = diff, y = 1)) +
  geom_vline(xintercept = 0, linetype = "11", col = "grey")+
  stat_slab(alpha = 0.3, aes(fill = factor(year))) +
  stat_slab(show.legend = F,size = .5,  fill = NA ,  aes(col = factor(year))) +
  scale_colour_manual(values = cols_year) +
  scale_fill_manual(values = cols_year) +
  guides(color = guide_legend(override.aes = list(alpha = 1)),
         fill = guide_legend(override.aes = list(alpha = 1))) +
  theme_clean()
```

```{r}
epred_bites_ab_be_S_effect %>% 
  compare_0(variable = diff,
          year)
```

No effect. Strong difference in 2016 if video is ignored

### Models Bouts

#### **Small**

Smooth not possible, remove all covariates, not enough combinations

```{r}
fit_bouts_ab_be_S <- brm(
  bout ~ factor(year) * treatment+(1|video),
  data = dat_bites_ab_be_S,
  family = poisson,  
  control = list(max_treedepth = 12, adapt_delta = 0.98),
  iter = 4000,
  warmup = 2000,
  chains = 4,
  cores = 4,
  seed = 123,
  file_refit = "on_change",
  file = here("models/fit_bouts_ab_be_S"),
  threads = threading(2, static = T),
  backend = "cmdstanr"
)
  
summary(fit_bouts_ab_be_S)#ok
pp_check(fit_bouts_ab_be_S, ndraws = 100)
bayes_R2(fit_bouts_ab_be_S)#0.75
```

#### Predict

```{r}
pred_bouts_ab_be_S <-  predicted_draws(
  fit_bouts_ab_be_S,
  newdata = expand_grid(
    year = dat_bites_ab_be_S$year %>% unique(),
    treatment = dat_bites_ab_be_S$treatment %>% unique()),
  re_formula = NA
)
```

```{r}
pred_bouts_ab_be_S %>%
  ggplot(aes(x = .prediction, y = year)) +
  stat_slab(size = .3,
            aes(fill = treatment),
            slab_size = 0.5, 
            alpha = 0.3) +
  stat_slab(show.legend = F, 
            size = .3,
            fill = NA, 
            aes(colour = treatment), 
            slab_size = 0.5) +
  scale_colour_manual(values = cols_treat)+
  scale_fill_manual(values = cols_treat)+
  guides(color = guide_legend(override.aes = list(alpha = 1)),
         fill = guide_legend(override.aes = list(alpha = 1)))+
  theme_clean()
```

Expected values

```{r}
epred_bouts_ab_be_S <-  epred_draws(
  fit_bouts_ab_be_S,
  newdata = expand_grid(
    year = dat_bites_ab_be_S$year %>% unique(),
    treatment = dat_bites_ab_be_S$treatment %>% unique()),
  re_formula = NA
)
```

```{r}
epred_bouts_ab_be_S %>%
  ggplot(aes(x = .epred, y = year)) +
  stat_slab(size = .3,
            aes(fill = treatment),
            slab_size = 0.5, 
            alpha = 0.3) +
  stat_slab(show.legend = F, 
            size = .3,
            fill = NA, 
            aes(colour = treatment), 
            slab_size = 0.5) +
  scale_colour_manual(values = cols_treat)+
  scale_fill_manual(values = cols_treat)+
  guides(color = guide_legend(override.aes = list(alpha = 1)),
         fill = guide_legend(override.aes = list(alpha = 1)))+
  theme_clean()
```

Effect

```{r}
epred_bouts_ab_be_S_effect <- epred_bouts_ab_be_S %>%
  ungroup() %>%
  dplyr::select(year,
                treatment,
                .draw,
                .epred) %>%
  pivot_wider(names_from = treatment, values_from = .epred) %>%
  mutate(diff = absent - before)
```

```{r}
epred_bouts_ab_be_S_effect %>% 
  ggplot(aes(x = diff, y = 1)) +
  geom_vline(xintercept = 0, linetype = "11", col = "grey")+
  stat_slab(alpha = 0.3, aes(fill = factor(year))) +
  stat_slab(show.legend = F,size = .5,  fill = NA ,  aes(col = factor(year))) +
  scale_colour_manual(values = cols_year) +
  scale_fill_manual(values = cols_year) +
  guides(color = guide_legend(override.aes = list(alpha = 1)),
         fill = guide_legend(override.aes = list(alpha = 1))) +
  theme_clean()
```

```{r}
epred_bouts_ab_be_S_effect %>% 
  compare_0(variable = diff,
          year)
```

Nothing
